## Based Cookie — геймификация и ончейн‑механики (черновик)

Источник идей: официальный репозиторий `farcasterxyz/miniapps`, проекты вроде Monad Fortune Cookies и Base Meme Slot.

Этот файл — опорный конспект для реализации фич из плана по мини‑приложению «сломай печеньку». Его можно использовать при проектировании API, контракта и UI.

---

### 1. Daily‑flow, кулдаун и streak

- **Пользовательский сценарий**
  - У пользователя есть **ежедневная главная фортуна**: 1 «основной» клейм в сутки, привязанный к FID + адресу.
  - Поддерживается **daily streak**: если пользователь приходит несколько дней подряд и успешно клеймит фортуны, растёт серия.
  - Пропуск дня сбрасывает streak.

- **Хранение / данные**
  - На сервере (или в БД/Supabase) хранить по ключу `(fid, walletAddress)`:
    - `lastClaimAt` — дата/время последнего клейма.
    - `dailyStreak` — текущая длина серии.
    - `totalClaims` — общее число клеймов.
  - Логика кулдауна: нельзя выдать новую «основную» фортуны, если с `lastClaimAt` прошло < 24 часов (или другой выбранный интервал).

- **Изменения в UI**
  - На главном экране (`app/page.tsx`):
    - Блок с таймером «до следующей печеньки» (если кулдаун активен).
    - Отображение текущего streak: «Ты на серии X дней, не ломай цепочку!».
  - Кнопка клейма становится disabled с понятным сообщением и счётчиком обратного отсчёта.

- **Изменения в backend**
  - Расширить API (например, `app/api/fortune/*`):
    - Эндпоинт для получения состояния: `GET /api/fortune/state` → `{ lastClaimAt, dailyStreak, totalClaims, canClaimNow, nextClaimAt }`.
    - Эндпоинт для клейма: `POST /api/fortune/claim` → проверка кулдауна, обновление streak и истории.

---

### 2. Редкости и коллекции фортуны

- **Пользовательский сценарий**
  - Каждая фортуна имеет **редкость**: `COMMON`, `RARE`, `LEGENDARY`.
  - У пользователя есть «коллекция» фортуны, сгруппированная по наборам (сетам), например:
    - «Onchain DeFi Set»,
    - «Meme Lord Set»,
    - «Degen Prophecies».
  - При сборе полного сета пользователь получает бонус (доп. клейм, редкую печеньку, ачивку).

- **Хранение / данные**
  - Справочник фортуны (можно хранить в файле/БД):
    - `fortuneId`, `text`, `rarity`, `setId`.
  - По пользователю:
    - список `claimedFortuneIds`,
    - агрегаты по редкости (сколько `RARE` / `LEGENDARY`),
    - прогресс по сетам: `collectedCount` / `totalInSet`.
  - При клейме выбирается фортуны с учётом:
    - базовых вероятностей по редкости,
    - текущего «pity‑таймера» (см. раздел 4).

- **Изменения в UI**
  - В карточке результата:
    - явный бейдж редкости (цвет, иконка, текст),
    - индикация сета (название + прогресс «собрано X/Y»).
  - Отдельный экран «Мои печеньки»:
    - список полученных фортуны с редкостью и датой;
    - сводка по сетам (что собрано/что осталось).

- **Изменения в backend/контракте**
  - На уровне контракта (при необходимости):
    - хранение класса награды (common/rare/legendary) и, возможно, `fortuneId`.
  - На уровне сервера:
    - бизнес‑логика выбора фортуны и редкости;
    - учёт «pity‑таймера» и прогресса по сетам.

---

### 3. Лидерборды и социальный слой

- **Пользовательский сценарий**
  - Лидерборд по разным метрикам:
    - **Top claimers** — по общему числу клеймов.
    - **Rare hunters** — по количеству редких/легендарных фортуны.
    - **Streak masters** — по максимальной длине streak.
  - В таблице видно:
    - Farcaster handle / avatar,
    - адрес (опционально),
    - ключевые метрики (клеймы, редкие фортуны, streak).

- **Хранение / данные**
  - Серверный агрегат по пользователям:
    - `fid`, `handle`, `walletAddress`,
    - `totalClaims`, `rareCount`, `legendaryCount`, `maxStreak`.
  - Поскольку данные обновляются не в реальном времени, можно:
    - периодически пересчитывать лидерборд (фоновой job),
    - или считать «на лету» по индексу/таблице.

- **Изменения в UI**
  - Новый маршрут `app/leaderboard/page.tsx`:
    - табы по типам лидерборда (claims / rare / streak),
    - таблица лидеров с пагинацией или top‑N (например top‑20),
    - подсветка текущего пользователя (если он есть в рейтинге).
  - На главном экране — компактный вид: топ‑3 или кнопка «Посмотреть всех».

- **Изменения в backend**
  - Эндпоинт: `GET /api/leaderboard?type=claims|rare|streak&limit=N`.
  - Возможный фоновый пересчёт (cron/edge‑job), если объём данных вырастет.

---

### 4. Ончейн‑механики наград

- **Пользовательский сценарий**
  - Опциональный **NFT‑mint** для самых редких/любимых фортуны:
    - пользователь выбирает конкретную фортуны из истории и минтит «печеньку‑сувенир»;
    - NFT может включать редкость, дату, streak, краткое описание.
  - «Pity‑таймер»:
    - если пользователь долго не получает редкую/легендарную фортуны, вероятность её выпадения растёт;
    - UI показывает прогресс: «ещё X клеймов до гарантированной редкой фортуны».

- **Хранение / данные**
  - Для NFT:
    - on‑chain: токен с метаданными (URI → JSON с текстом, редкостью, датой и т.п.);
    - off‑chain: хранилище метаданных (IPFS, Arweave, базовый CDN).
  - Для pity‑таймера:
    - `claimsSinceLastRare`,
    - `claimsSinceLastLegendary`,
    - параметры порога гарантированного дропа (например, каждые N клеймов).

- **Изменения в UI**
  - В истории фортуны — кнопка «заминтить» для подходящих записей (редких/легендарных).
  - На главном экране — прогрессбар pity‑таймера.

- **Изменения в backend/контракте**
  - Контракт:
    - поддержка минта NFT с параметрами фортуны;
    - возможное кодирование редкости в токене.
  - Сервер:
    - расчёт pity‑таймера и выдача редкости при клейме;
    - формирование метаданных для NFT.

---

### 5. Mini App‑специфичный UX (Farcaster контекст)

- **Пользовательский сценарий**
  - Приложение встроено в Farcaster‑клиент и знает FID/handle пользователя.
  - Быстрые действия прямо из мини‑аппа:
    - «Разбить ещё одну печеньку (через X часов)»;
    - «Открыть историю»;
    - «Посмотреть лидерборд».
  - Упор на быстрый, «моментальный» UX: минимум шагов от открытия до клейма.

- **Использование MiniApp SDK**
  - `@farcaster/miniapp-sdk`:
    - `sdk.actions.ready()` — скрыть splash как только UI готов.
    - Использовать контекст пользователя (FID, возможно handle) для персонализации текста.
    - Использовать `openUrl` / другие действия для переходов (например, на шаринг‑линки).

- **Интеграция с существующим кодом**
  - `app/page.tsx`:
    - инициализация MiniApp SDK,
    - запрос состояния (`/api/fortune/state`) при монтировании,
    - обработка клейма с учётом кулдауна, редкости и pity‑таймера.
  - `app/api/auth/route.ts`:
    - источник FID и базового профиля пользователя.
  - Дополнительные маршруты:
    - `app/history/page.tsx` — история фортуны;
    - `app/leaderboard/page.tsx` — лидерборд;
    - при необходимости — `app/share/page.tsx` для индивидуальных share‑страниц.

---

### 6. Связь с текущим планом

- **Персонализация по FID**
  - Привязать к FID/адресу: `dailyStreak`, `totalClaims`, историю фортуны и редкости.
  - Выводить персонифицированные тексты и прогресс по сетам.

- **Серверный учёт форчун и клеймов**
  - Вести историю предсказаний, редкостей, сетов и NFT‑минтов.
  - Служить источником данных для лидерборда, истории и pity‑таймера.

- **Социальный слой и геймификация**
  - Лидерборды по клеймам, редким фортунам и streak.
  - Ачивки за завершённые наборы и длинные серии.

- **Расширение ончейн‑механики**
  - Многие идеи выше (редкости, pity‑таймер, NFT‑сувениры) реализуются в смарт‑контракте и привязаны к UI.

